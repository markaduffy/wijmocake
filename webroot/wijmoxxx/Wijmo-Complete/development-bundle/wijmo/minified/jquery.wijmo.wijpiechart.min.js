/*
 *
 * Wijmo Library 1.4.1
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";a.widget("wijmo.wijpiechart",a.wijmo.wijchartcore,{options:{radius:null,innerRadius:0,animation:{enabled:true,duration:400,easing:">",offset:10},seriesTransition:{enabled:true,duration:1e3,easing:"bounce"},mouseDown:null,mouseUp:null,mouseOver:null,mouseOut:null,mouseMove:null,click:null},_create:function(){var b=this,c=["0-#8ac4c0-#77b3af","0-#73a19e-#67908e","0-#4f687b-#465d6e","0-#69475b-#5d3f51","0-#7a3b3f-#682e32","0-#9d5b5b-#8c5151","0-#e5a36d-#ce9262","0-#e6cc70-#ceb664","0-#8ec858-#7fb34f","0-#3a9073-#2a7b5f","0-#6c88e3-#6079cb","0-#6cb4e3-#60a0cb"];a.wijmo.wijchartcore.prototype._create.apply(b,arguments);b.chartElement.addClass("wijmo-wijpiechart");a.each(this.options.seriesStyles,function(b,a){if(!a.fill)a.fill=c[b]});b.canvas.customAttributes.segment=function(h,i,d,a,g,f){var e=null,c=.01;if(a-d>360-c)a-=c;else if(a-d<c)a+=c;if(f)e=b._donut(h,i,g,f,d,a);else e=b._sector(h,i,g,d,a);return{path:e}}},destroy:function(){var b=this;b.chartElement.removeClass("wijmo-wijpiechart ui-helper-reset");a.wijmo.wijchartcore.prototype.destroy.apply(this,arguments);if(b.aniSectors&&b.aniSectors.length){a.each(b.aniSectors,function(b,a){a=null});b.aniSectors=null}if(b.aniLabels&&b.aniLabels.length){a.each(b.aniLabels,function(b,a){a=null});b.aniLabels=null}},_isPieChart:function(){return true},getSector:function(a){return this.sectors[a]},_getSeriesFromTR:function(i,e,h){var d=null,g=null,b=null,f=null,c=null;e.length&&e.each(function(){g=a("th",a(this));d=a.trim(g.text());b=a("td",a(this));if(b.length)f=parseFloat(a.trim(a(b[0]).text()));c={label:d,legendEntry:true,data:f};h.push(c)})},_paintPlotArea:function(){var c=this,b=c.options,d=c.canvasBounds,i=d.endX-d.startX,h=d.endY-d.startY,p=b.seriesList,u=b.seriesStyles,t=b.seriesHoverStyles,n=0,l=[],k=[],q=[],f=0,m=c.canvas,j=m.wij.getPositionByAngle,g,r,s,o,e;if(!b.radius)b.radius=Math.min(i,h)/2;else{if(i<2*b.radius)b.radius=i/2;if(h<2*b.radius)b.radius=h/2}d.startX+=i/2-b.radius;d.endX=d.startX+2*b.radius;d.startY+=h/2-b.radius;d.endY=d.startY+2*b.radius;a.each(p,function(b,a){if(a&&typeof a.data==="number")n+=a.data});r=d.startX;s=d.startY;c.total=n;g=b.radius;a.each(p,function(i,h){var p=a.extend({opacity:1,stroke:"gray","stroke-width":1},u[i]),A=360*h.data/n,x=r+g,y=s+g,B,d,w,z,v;h=a.extend(true,{offset:0},h);if(h.offset){B=j(x,y,h.offset,f+A/2);x=B.x;y=B.y}o=[x,y,f,f+A,g,b.innerRadius].concat(" ");if(c.aniSectors&&b.seriesTransition.enabled){p.segment=o;if(i<c.aniSectors.length){e=c.aniSectors[i].attr();c.aniSectors[i].stop()}else{e=a.extend(true,{},p);e.segment=[x,y,0,360,g,b.innerRadius].concat(" ")}d=c.canvas.path().attr(e);p=c._getDiffAttrs(e,p);d.wijAnimate(p,b.seriesTransition.duration,b.seriesTransition.easing,function(){c._paintShadow(d);delete p.segment})}else{d=c.canvas.path().attr({segment:o});c._paintShadow(d);d.wijAttr(p)}d.angles={start:f,end:f+A};d.getOffset=function(b){var a=j(x,y,b,(d.angles.start+d.angles.end)/2);return{x:a.x-x,y:a.y-y}};d.center={x:x,y:y};d.radius=g;if(b.innerRadius)d.innerRadius=b.innerRadius;c._addClass(a(d.node),"wijchart-canvas-object");a(d.node).data("wijchartDataObj",h);if(b.showChartLabels){z=j(x,y,h.offset+g*2/3,f+A/2);v=a.extend(true,{},b.textStyle,b.chartLabelStyle);if(c.aniLabels&&b.seriesTransition.enabled)if(i<c.aniLabels.length){e=c.aniLabels[i].attr();c.aniLabels[i].stop();e.text=h.label;w=c.canvas.text(0,0,"").attr(e);v=c._getDiffAttrs(e,v);v.x=z.x;v.y=z.y;w.wijAnimate(v,b.seriesTransition.duration,b.seriesTransition.easing)}else w=m.text(z.x,z.y,h.label).attr(v);else w=m.text(z.x,z.y,h.label).attr(v);c._addClass(a(w.node),"wijchart-canvas-object");a(w.node).data("wijchartDataObj",h);k.push(w);q.push(w)}l.push(d);k.push(d);h.style=p;h.hoverStyle=t[i];h.index=i;h.type="pie";f+=A});c.aniSectors=l;c.aniLabels=q;c.sectors=l;c.tooltipTars=k},_paintChartLabels:function(){var b=this,c=b.options,d=c.chartLabels,e=0,f=c.radius;if(!d||!d.length)return;a.each(d,function(v,u){var o=b.canvasBounds.startX+f,p=b.canvasBounds.startY+f,i=a.extend(true,{compass:"east",attachMethod:"coordinate",attachMethodData:{seriesIndex:-1,x:-1,y:-1},offset:0,visible:false,text:"",connected:false},u),r,t,g,d,n,h,j,s,l,k,m,q=b.canvas.wij.getPositionByAngle;if(!i.visible)return true;r=i.attachMethod;t=i.attachMethodData;g={x:0,y:0};d=0;n=null;if(r==="dataIndex"){h=t.seriesIndex;if(h>-1){j=c.seriesList[h];s=j.data;l=360*s/b.total;k=c.seriesStyles[h];n={stroke:k.stroke||k.fill};d=e+l/2;if(j.offset){m=q(o,p,j.offset,d);o=m.x;p=m.y}g=q(o,p,f,d);e=e+l}}if(isNaN(g.x)||isNaN(g.y))return false;b._setChartLabel(i,g,d,n)})},_getTooltipText:function(d,c){var b=a(c.node).data("wijchartDataObj"),f=b.data,e;e={value:f,total:this.total,data:b,target:c,fmt:d};return a.proxy(d,e)()},_bindLiveEvents:function(){var b=this,c=this.options,l=c.hint.enable,h=b.tooltip,e={x:0,y:0},d,k,j,g=[],f=[],i=[];if(l&&!h){d=a.extend(true,{},c.hint);d.offsetY=d.offsetY||-2;k=c.hint.title;j=c.hint.content;if(a.isFunction(k))d.title=function(){return b._getTooltipText(k,this.target)};if(a.isFunction(j))d.content=function(){return b._getTooltipText(j,this.target)};d.beforeShowing=function(){if(this.target)this.options.style.stroke=this.target.attrs.stroke||this.target.attrs.fill};h=b.canvas.tooltip(b.tooltipTars,d);b.tooltip=h}a(".wijchart-canvas-object",this.chartElement[0]).live("mousedown.wijpiechart",function(e){if(c.disabled)return;var d=a(e.target).data("wijchartDataObj");if(!d)d=a(e.target.parentNode).data("wijchartDataObj");b._trigger("mouseDown",e,d)}).live("mouseup.wijpiechart",function(e){if(c.disabled)return;var d=a(e.target).data("wijchartDataObj");if(!d)d=a(e.target.parentNode).data("wijchartDataObj");b._trigger("mouseUp",e,d)}).live("mouseover.wijpiechart",function(o){if(c.disabled)return;var k=a(o.target).data("wijchartDataObj"),j=c.animation,p=j&&j.enabled,d,l,h,n,m;if(!k)k=a(o.target.parentNode).data("wijchartDataObj");d=k.index;l=b.getSector(d);h=g[d];n=f[d];m=i[d];l.wijAttr(k.hoverStyle);b._trigger("mouseOver",o,k);if(p){if(n){window.clearTimeout(n);n=null;f[d]=null}if(h){window.clearTimeout(h);h=null;g[d]=null}if(m)return;h=window.setTimeout(function(){var a=j.duration,b=j.easing;if(l.removed)return;e=l.getOffset(j.offset);l.wijAnimate({translation:e.x+" "+e.y},a,b);m=true;i[d]=m},150);g[d]=h}}).live("mouseout.wijpiechart",function(p){if(c.disabled)return;var j=a(p.target).data("wijchartDataObj"),n=c.animation,q=n&&n.enabled,d,o,m,k,l;if(!j)j=a(p.target.parentNode).data("wijchartDataObj");d=j.index;o=b.getSector(d);m=g[d];k=f[d];l=i[d];b._trigger("mouseOut",p,j);if(j.style.segment)delete j.style.segment;o.wijAttr(j.style);h&&h.hide();if(q){if(k){window.clearTimeout(k);k=null;f[d]=null}if(m){window.clearTimeout(m);m=null;g[d]=null}if(!l)return;k=window.setTimeout(function(){var a=n.duration,b=n.easing;o.wijAnimate({translation:-e.x+" "+-e.y},a,b);e={x:0,y:0};l=false;i[d]=l},150);f[d]=k}}).live("mousemove.wijpiechart",function(e){if(c.disabled)return;var d=a(e.target).data("wijchartDataObj");if(!d)d=a(e.target.parentNode).data("wijchartDataObj");b._trigger("mouseMove",e,d)}).live("click.wijpiechart",function(e){if(c.disabled)return;var d=a(e.target).data("wijchartDataObj");if(!d)d=a(e.target.parentNode).data("wijchartDataObj");b._trigger("click",e,d)})},_unbindLiveEvents:function(){var b=this;a(".wijchart-canvas-object",b.chartElement[0]).die("wijpiechart");if(b.tooltip){b.tooltip.destroy();b.tooltip=null}},_sector:function(b,c,a,d,e){var g=this,f=g._getPositionByAngle(b,c,a,d),h=g._getPositionByAngle(b,c,a,e);return["M",b,c,"L",f.x,f.y,"A",a,a,0,+(e-d>180),0,h.x,h.y,"z"]},_donut:function(e,f,b,a,g,h){var d=this,c=d._getPositionByAngle(e,f,b,g),l=d._getPositionByAngle(e,f,b,h),k=d._getPositionByAngle(e,f,a,g),j=d._getPositionByAngle(e,f,a,h),i=h-g>180;return["M",c.x,c.y,"A",b,b,0,+i,0,l.x,l.y,"L",j.x,j.y,"A",a,a,0,+i,1,k.x,k.y,"L",c.x,c.y,"z"]},_getPositionByAngle:function(e,f,c,d){var a={},b=Raphael.rad(d);a.x=e+c*Math.cos(-1*b);a.y=f+c*Math.sin(-1*b);return a}})})(jQuery);